USE [PROJECTOR_TRACE]
GO
/****** Object:  StoredProcedure [dbo].[LoadDataHistoryPT]    Script Date: 9/29/2022 4:45:27 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[LoadDataHistoryPT] --	LoadDataHistoryPT '', '2021-02-24' , '2022-09-27', 'GB1530023'
@model nvarchar(30),
@fromDT varchar(20),
@toDT varchar(20),
@serial nvarchar(30)

AS
BEGIN

declare @condition nvarchar(500)
declare @sql nvarchar(max)

	set @condition = ' WHERE 1 = 1 '
if @model <> ''
	set @condition += ' AND MODELCODE = (SELECT MODEL_CODE FROM TBL_MODEL WHERE MODEL_NM = '''+@model+''') '
if @fromDT <> '' or @toDT <> ''
	--set @condition +=  ' AND  ((CONVERT(DATE,INSERTDT) BETWEEN '''+@fromDT+''' AND '''+@toDT+''') OR (CONVERT(DATE, INSERT_DT) BETWEEN '''+@fromDT+''' AND '''+@toDT+''')) '
	set @condition +=  ' AND  (CONVERT(DATE,INSERTDT) BETWEEN '''+@fromDT+''' AND '''+@toDT+''')  '
	   --AND CONVERT(DATE,INSERTDT) BETWEEN '''+@fromDT+''' AND '''+@toDT+''' 

if @serial <> ''
	set @condition += ' and (TEMPORY_SERIAL = '''+@serial+''' OR PROD_SERIAL = '''+@serial+''') '

	set @sql = '
	SELECT  * FROM
	(
	select a.ID 
	, (SELECT MODEL_NM FROM TBL_MODEL WHERE A.MODELCODE = MODEL_CODE) AS MODEL_NM
	, a.TEMPORY_SERIAL
	, a.OPTICALID
	, (SELECT PRODUCT_SERIAL FROM [PROJECTOR_TRACE].[dbo].TBL_VISUAL_CHECK WHERE TEMPORY_SERIAL = A.TEMPORY_SERIAL AND DELETE_FLAG = ''N'' ) AS PROD_SERIAL
	, INSERTDT AS ASSY2
	, CASE WHEN EXISTS (SELECT 1 FROM [PROJECTOR_TRACE].[dbo].[TBL_TRACE_ADJUST] where DELETE_FLAG = ''N'' and TEMPORY_SERIAL = a.TEMPORY_SERIAL) 
			THEN (SELECT INSERT_DT FROM [PROJECTOR_TRACE].[dbo].[TBL_TRACE_ADJUST] where DELETE_FLAG = ''N'' and TEMPORY_SERIAL = a.TEMPORY_SERIAL)
			END AS ASSY4
	, CASE WHEN EXISTS (SELECT 1 FROM [PROJECTOR_TRACE].[dbo].TBL_VISUAL_CHECK where (DELETE_FLAG = ''N'' ) and TEMPORY_SERIAL = a.TEMPORY_SERIAL) 
			THEN (SELECT INSERT_DT FROM [PROJECTOR_TRACE].[dbo].TBL_VISUAL_CHECK where (DELETE_FLAG = ''N''  ) and TEMPORY_SERIAL = a.TEMPORY_SERIAL)
			END AS VISUAL_CHECK
	, CASE WHEN EXISTS (SELECT 1 FROM [PROJECTOR_TRACE].[dbo].[TBL_ACCESSORIES_CHECK] where DELETE_FLAG = ''N'' and TEMPORY_SERIAL = a.TEMPORY_SERIAL) 
			THEN (SELECT INSERT_DT FROM [PROJECTOR_TRACE].[dbo].[TBL_ACCESSORIES_CHECK] where DELETE_FLAG = ''N'' and TEMPORY_SERIAL = a.TEMPORY_SERIAL)
			END AS ACCESSORIES_DT
	,CASE WHEN EXISTS (SELECT TOP(1) 1 FROM [WeightSys].[dbo].[Weight_PT] where DELETE_FLAG = ''N'' and STR_PROCESS = MODEL_CODE2 and  STR_SERIAL = (SELECT PRODUCT_SERIAL FROM [PROJECTOR_TRACE].[dbo].TBL_VISUAL_CHECK WHERE TEMPORY_SERIAL = A.TEMPORY_SERIAL AND DELETE_FLAG = ''N'' ) ORDER BY DATE_INTO_SQL DESC) 
			THEN (SELECT TOP(1) DATE_INTO_SQL FROM [WeightSys].[dbo].[Weight_PT] where DELETE_FLAG = ''N'' and STR_PROCESS = MODEL_CODE2 and STR_SERIAL = (SELECT PRODUCT_SERIAL FROM [PROJECTOR_TRACE].[dbo].TBL_VISUAL_CHECK WHERE TEMPORY_SERIAL = A.TEMPORY_SERIAL AND DELETE_FLAG = ''N'' ) ORDER BY DATE_INTO_SQL DESC)
			END AS WEIGHT_DT
	,CASE WHEN EXISTS (SELECT TOP(1) 1 FROM [FOSS1].[dbo].[tblPalletCombine_PT] where REPLACE( sModelNo, ''-V4'', '''')  = MODEL_CODE2 and  sSerialNo = (SELECT PRODUCT_SERIAL FROM [PROJECTOR_TRACE].[dbo].TBL_VISUAL_CHECK WHERE TEMPORY_SERIAL = A.TEMPORY_SERIAL AND DELETE_FLAG = ''N'' ) ORDER BY dShrinkDate DESC) 
			THEN (SELECT TOP(1) dShrinkDate FROM [FOSS1].[dbo].[tblPalletCombine_PT] where  REPLACE( sModelNo, ''-V4'', '''')  = MODEL_CODE2 and  sSerialNo = (SELECT PRODUCT_SERIAL FROM [PROJECTOR_TRACE].[dbo].TBL_VISUAL_CHECK WHERE TEMPORY_SERIAL = A.TEMPORY_SERIAL AND DELETE_FLAG = ''N'' ) ORDER BY dShrinkDate DESC)
			END AS SHRINK_DT
	,INSERTDT, MODELCODE,INSERT_DT
	from [PROJECTOR_TRACE].[dbo].[TBL_FA_INFOR] a  inner join [PROJECTOR_TRACE].[dbo].TBL_VISUAL_CHECK b on a.TEMPORY_SERIAL = b.TEMPORY_SERIAL
		where a.DELETE_FLAG = ''N''  and b.DELETE_FLAG = ''N''

	) AS KK
	 
 '
		--order by INSERTDT 
		set @sql += @condition + ' ORDER BY INSERTDT'

		print @sql
		exec(@sql)
		
END





